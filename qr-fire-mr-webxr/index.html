<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR MR Fire - Quest 3 „Éû„Éº„Ç´„Éº„Éô„Éº„ÇπÁÇéAR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
        }
        #info h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 999;
            text-align: center;
        }
        #enterMR {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #FF4500, #FF6347);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            z-index: 9999;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
            display: block;
        }
        #enterMR:hover {
            background: linear-gradient(135deg, #FF6347, #FF4500);
        }
        #enterMR:disabled {
            background: gray;
            cursor: not-allowed;
        }
        #enterMR:active {
            transform: translateX(-50%) scale(0.95);
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>üî• WebXR MR Fire</h3>
        <p id="status">Quest 3„ÅßMR„É¢„Éº„Éâ„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        <p id="debug">ÂæÖÊ©ü‰∏≠...</p>
    </div>

    <div class="loading" id="loading">
        <p>MindAR„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        <p style="font-size: 12px;">Quest 3„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</p>
    </div>

    <button id="enterMR">MR„É¢„Éº„Éâ„Å´ÂÖ•„Çã üî•</button>

    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no;"
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        xr-mode-ui="enabled: false"
    >
        <!-- Áí∞Â¢ÉÂÖâ -->
        <a-light type="ambient" color="#fff" intensity="0.8"></a-light>

        <!-- „Ç´„É°„É© -->
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- „Éû„Éº„Ç´„Éº„Çø„Éº„Ç≤„ÉÉ„Éà -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- ÁÇé„ÅÆ„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁô∫ÂÖâÔºâ -->
            <a-sphere
                position="0 0.2 0"
                radius="0.3"
                material="color: #FF4500; shader: flat; emissive: #FF4500; emissiveIntensity: 1"
                animation="property: scale; to: 1.2 1.5 1.2; loop: true; dir: alternate; dur: 500; easing: easeInOutQuad"
            ></a-sphere>

            <a-sphere
                position="0 0.5 0"
                radius="0.25"
                material="color: #FFD700; shader: flat; emissive: #FFD700; emissiveIntensity: 1"
                animation="property: scale; to: 1.3 1.6 1.3; loop: true; dir: alternate; dur: 400; easing: easeInOutQuad"
            ></a-sphere>

            <a-sphere
                position="0 0.8 0"
                radius="0.2"
                material="color: #FF6600; shader: flat; emissive: #FF6600; emissiveIntensity: 1"
                animation="property: scale; to: 1.4 1.7 1.4; loop: true; dir: alternate; dur: 350; easing: easeInOutQuad"
            ></a-sphere>

            <a-sphere
                position="0 1.0 0"
                radius="0.15"
                material="color: #FFFF00; shader: flat; emissive: #FFFF00; emissiveIntensity: 1"
                animation="property: scale; to: 1.5 1.8 1.5; loop: true; dir: alternate; dur: 300; easing: easeInOutQuad"
            ></a-sphere>

            <!-- Êè∫„Çâ„Åé„Ç®„Éï„Çß„ÇØ„Éà -->
            <a-sphere
                position="0 0.3 0"
                radius="0.15"
                material="color: #FF0000; shader: flat; emissive: #FF0000; emissiveIntensity: 1; opacity: 0.7"
                animation__pos="property: position; to: -0.1 0.6 0; loop: true; dir: alternate; dur: 600; easing: easeInOutSine"
                animation__scale="property: scale; to: 0.8 1.2 0.8; loop: true; dir: alternate; dur: 400"
            ></a-sphere>

            <a-sphere
                position="0 0.3 0"
                radius="0.15"
                material="color: #FF0000; shader: flat; emissive: #FF0000; emissiveIntensity: 1; opacity: 0.7"
                animation__pos="property: position; to: 0.1 0.7 0; loop: true; dir: alternate; dur: 700; easing: easeInOutSine"
                animation__scale="property: scale; to: 0.9 1.3 0.9; loop: true; dir: alternate; dur: 450"
            ></a-sphere>

            <!-- ÂÖâÊ∫ê -->
            <a-light type="point" intensity="2" color="#FF4500" distance="5" position="0 0.5 0"></a-light>
        </a-entity>
    </a-scene>

    <script>
        const sceneEl = document.querySelector('a-scene');
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        const loadingEl = document.getElementById('loading');
        const enterMRBtn = document.getElementById('enterMR');

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü
        window.addEventListener('load', () => {
            debugEl.textContent = 'MindARË™≠„ÅøËæº„ÅøÂÆå‰∫Ü';

            // A-Frame„ÅÆ„Ç∑„Éº„É≥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
            sceneEl.addEventListener('loaded', () => {
                loadingEl.style.display = 'none';
                debugEl.textContent = '„Ç∑„Éº„É≥Ê∫ñÂÇôÂÆå‰∫Ü';
            });
        });

        // MR„É¢„Éº„Éâ„Éú„Çø„É≥
        enterMRBtn.addEventListener('click', async () => {
            debugEl.textContent = '„Ç´„É°„É©Ê®©Èôê„ÇíË¶ÅÊ±Ç‰∏≠...';

            try {
                // „Åæ„Åö„Ç´„É°„É©Ê®©Èôê„ÇíÊòéÁ§∫ÁöÑ„Å´Ë¶ÅÊ±Ç
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                debugEl.textContent = '„Ç´„É°„É©Ê®©ÈôêÂèñÂæóÊàêÂäü';
                console.log('„Ç´„É°„É©„Çπ„Éà„É™„Éº„É†ÂèñÂæó:', stream);

                // „Çπ„Éà„É™„Éº„É†„Çí‰∏ÄÊó¶ÂÅúÊ≠¢ÔºàMindAR„ÅåÂÜçÂ∫¶ÂèñÂæó„Åô„Çã„Åü„ÇÅÔºâ
                stream.getTracks().forEach(track => track.stop());

                debugEl.textContent = 'MindAR„ÇíËµ∑Âãï‰∏≠...';

                // MindAR„ÇíÈñãÂßã
                const arSystem = sceneEl.systems['mindar-image-system'];
                await arSystem.start();

                statusEl.textContent = '„Éû„Éº„Ç´„Éº„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ';
                debugEl.textContent = '„Éû„Éº„Ç´„ÉºÊ§úÂá∫‰∏≠...';
                enterMRBtn.style.display = 'none';

            } catch (error) {
                console.error('MR„É¢„Éº„ÉâËµ∑Âãï„Ç®„É©„Éº:', error);
                debugEl.textContent = '„Ç®„É©„Éº: ' + error.message;
                statusEl.textContent = '„Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü';

                if (error.name === 'NotAllowedError') {
                    statusEl.textContent = '„Ç´„É°„É©Ê®©Èôê„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                } else if (error.name === 'NotFoundError') {
                    statusEl.textContent = '„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (error.name === 'NotReadableError') {
                    statusEl.textContent = '„Ç´„É°„É©„Åå‰ªñ„ÅÆ„Ç¢„Éó„É™„Åß‰ΩøÁî®‰∏≠„Åß„Åô';
                }
            }
        });

        // „Éû„Éº„Ç´„ÉºÊ§úÂá∫„Ç§„Éô„É≥„Éà
        sceneEl.addEventListener('targetFound', (event) => {
            console.log('üî• „Éû„Éº„Ç´„Éº„ÇíÊ§úÂá∫„Åó„Åæ„Åó„ÅüÔºÅ');
            statusEl.textContent = '‚úÖ „Éû„Éº„Ç´„ÉºÊ§úÂá∫ÔºÅÁÇé„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô';
            statusEl.style.color = '#00ff00';
            debugEl.textContent = 'ÁÇé„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫‰∏≠';
        });

        sceneEl.addEventListener('targetLost', (event) => {
            console.log('‚ùå „Éû„Éº„Ç´„Éº„ÇíË¶ãÂ§±„ÅÑ„Åæ„Åó„Åü');
            statusEl.textContent = '„Éû„Éº„Ç´„Éº„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ';
            statusEl.style.color = '#ffffff';
            debugEl.textContent = '„Éû„Éº„Ç´„Éº„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô...';
        });

        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', (event) => {
            console.error('„Ç®„É©„Éº:', event.error);
            debugEl.textContent = '„Ç®„É©„ÉºÁô∫Áîü: ' + event.error.message;
        });
    </script>
</body>
</html>
